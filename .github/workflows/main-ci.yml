name: Main CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/**'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  validate:
    name: Validate Build
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      node-version: '20.x'
      working-directory: './app'

  build-ios:
    name: Build iOS
    needs: validate
    uses: ./.github/workflows/ios-build.yml
    with:
      build-mode: 'Debug'
      create-archive: false

  build-summary:
    name: Build Summary
    needs: [validate, build-ios]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Main Branch Status
        run: |
          echo "## Main Branch CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validation status
          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "✅ **Validation:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Validation:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # iOS build status
          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "✅ **iOS Build:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **iOS Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Code linting (ESLint)" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests (Jest)" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies validation" >> $GITHUB_STEP_SUMMARY
          echo "- iOS build verification (Debug mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- 🚀 To deploy to TestFlight, trigger the **iOS TestFlight Deployment** workflow manually" >> $GITHUB_STEP_SUMMARY
          echo "- 📱 iOS .app artifact available for download (7 days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
