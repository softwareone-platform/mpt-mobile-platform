name: iOS Testing with External Build

permissions:
  contents: read
  actions: read    # Required for downloading artifacts

# Example workflow showing how to use the iOS install template 
# with an external build download URL
#
# To get the download URL from the main build workflow:
# 1. Run the 'iOS Build and Appium Tests' workflow 
# 2. Check the build job summary for the release asset URL
# 3. Use that URL as the download_url input for this workflow

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: false
        type: choice
        options:
          - test
        default: 'test'
      download_url:
        description: 'Direct download URL for the iOS app bundle (example: from GitHub releases or external URL)'
        required: true
        type: string
        default: 'https://github.com/softwareone-platform/mpt-mobile-platform/releases/download/build-Release-95c0d81527e369c3acfda2bc040cf7a400d5e3f9-64/app_bundle.zip'
      ios_version:
        description: 'iOS platform version for simulator'
        required: false
        type: string
        default: '26.0'
      device_name:
        description: 'iOS simulator device name'
        required: false
        type: string
        default: 'iPhone 16'

jobs:
  install-and-test-external-ios:
    name: Install and Test External iOS Build
    runs-on: macos-latest
    timeout-minutes: 60
    environment: ${{ inputs.environment || 'test' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Install phase using composite action template
      - name: Install External iOS App
        id: install-ios
        uses: ./.github/actions/ios-install
        with:
          # Use the provided download URL, or default for automatic triggers
          download_url: ${{ inputs.download_url || 'https://github.com/softwareone-platform/mpt-mobile-platform/releases/download/build-Release-95c0d81527e369c3acfda2bc040cf7a400d5e3f9-64/app_bundle.zip' }}
          ios_version: ${{ inputs.ios_version || '26.0' }}
          device_name: ${{ inputs.device_name || 'iPhone 16' }}
          
      # Test phase using composite action template  
      - name: Test External iOS App
        uses: ./.github/actions/ios-test
        with:
          device_uuid: ${{ steps.install-ios.outputs.device_udid }}
          ios_version: ${{ inputs.ios_version || '26.0' }}
          device_name: ${{ inputs.device_name || 'iPhone 16' }}
          node_version: '20'
          appium_version: '3.1.1'
          app_bundle_id: ${{ steps.install-ios.outputs.bundle_id }}
          appium_host: 'localhost'
          appium_port: '4723'
          airtable_email: ${{ secrets.AIRTABLE_EMAIL }}
          airtable_api_token: ${{ secrets.AIRTABLE_API_TOKEN }}
          airtable_base_id: ${{ secrets.AIRTABLE_BASE_ID }}
          airtable_table_name: ${{ secrets.AIRTABLE_TABLE_NAME }}
          airtable_from_email: ${{ secrets.AIRTABLE_FROM_EMAIL }}
          # ReportPortal configuration (enabled if API key is set)
          report_portal_api_key: ${{ secrets.REPORT_PORTAL_API_KEY || '' }}
          report_portal_endpoint: ${{ vars.REPORT_PORTAL_ENDPOINT }}
          report_portal_project: ${{ vars.REPORT_PORTAL_PROJECT }}
          report_portal_launch_name: 'iOS External Build Tests'
