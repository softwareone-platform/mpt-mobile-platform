name: PR Build & Test

on:
  pull_request:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/**'

  # Allow manual trigger for testing
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate PR
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      node-version: '20.x'
      working-directory: './app'

  pr-summary:
    name: PR Summary
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: PR Status Check
        run: |
          echo "## ✅ PR Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate.result }}" == "success" ]; then
            echo "### ✅ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- 🔍 Code linting (ESLint) - Zero warnings allowed" >> $GITHUB_STEP_SUMMARY
          echo "- 🧪 Unit tests (Jest) - With coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 Dependencies validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📱 iOS Build Status" >> $GITHUB_STEP_SUMMARY
          echo "**PR Stage:** iOS builds are not performed on PRs (cost optimization)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**After Merge:** iOS build will **automatically run** when merged to \`main\` branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Review code changes" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Merge to \`main\` when approved" >> $GITHUB_STEP_SUMMARY
          echo "3. 🤖 Main CI will automatically:" >> $GITHUB_STEP_SUMMARY
          echo "   - Run validation checks again" >> $GITHUB_STEP_SUMMARY
          echo "   - Build iOS app for verification (~20-30 min)" >> $GITHUB_STEP_SUMMARY
          echo "   - Upload iOS .app artifact (7-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "4. 🚀 To deploy to TestFlight: Manually trigger **iOS TestFlight Deployment** workflow" >> $GITHUB_STEP_SUMMARY
