name: 'iOS Appium Testing'
description: 'Setup and run Appium tests on iOS simulator'
inputs:
  device_uuid:
    description: 'iOS simulator device UUID'
    required: true
  device_name:
    description: 'iOS simulator device name'
    required: false
    default: 'iPhone 16'
  ios_version:
    description: 'iOS version'
    required: false
    default: '26.0'
  node_version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  appium_version:
    description: 'Appium version to install'
    required: false
    default: '3.1.1'
  app_bundle_id:
    description: 'iOS app bundle identifier'
    required: true
  appium_host:
    description: 'Appium server host'
    required: false
    default: 'localhost'
  appium_port:
    description: 'Appium server port'
    required: false
    default: '4723'

runs:
  using: 'composite'
  steps:
    - name: Verify Required Inputs
      shell: bash
      run: |
        echo "ðŸ” Verifying required inputs..."
        
        # Check required inputs
        if [ -z "${{ inputs.app_bundle_id }}" ]; then
          echo "âŒ ERROR: app_bundle_id input is required"
          exit 1
        else
          echo "âœ… app_bundle_id is set"
        fi
        
        # Check optional inputs (show defaults if not set)
        if [ -z "${{ inputs.appium_host }}" ]; then
          echo "â„¹ï¸  appium_host not set, using default: localhost"
        else
          echo "âœ… appium_host is set"
        fi
        
        if [ -z "${{ inputs.appium_port }}" ]; then
          echo "â„¹ï¸  appium_port not set, using default: 4723"
        else
          echo "âœ… appium_port is set"
        fi
        
        # Verify required inputs
        if [ -z "${{ inputs.device_uuid }}" ]; then
          echo "âŒ ERROR: device_uuid input is required"
          exit 1
        else
          echo "âœ… device_uuid input is provided: ${{ inputs.device_uuid }}"
        fi
        
        echo "ðŸŽ‰ All required inputs are properly configured!"

    - name: Checkout test repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json

    - name: Restore node modules cache
      id: npm-cache
      uses: actions/cache@v4
      with:
        path: |
          app/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies (only missing packages)
      shell: bash
      run: npm ci
      working-directory: ./app

    - name: Install Appium
      shell: bash
      run: |
        npm install -g appium@${{ inputs.appium_version }}
        appium --version
        
    - name: Install Appium XCUITest driver
      shell: bash
      run: |
        appium driver install xcuitest || echo "Driver already installed"
        appium driver list --installed

    - name: Verify simulator and app are ready
      shell: bash
      env:
        DEVICE_UDID: ${{ inputs.device_uuid }}
        APP_BUNDLE_ID: ${{ inputs.app_bundle_id }}
      run: |
        echo "ðŸ” Verifying simulator and app setup from install workflow..."
        
        # Check simulator status
        SIMULATOR_STATUS=$(xcrun simctl list devices | grep "${{ env.DEVICE_UDID }}" | head -1 || echo "Not found")
        echo "Simulator status: $SIMULATOR_STATUS"
        
        if echo "$SIMULATOR_STATUS" | grep -q "(Booted)"; then
          echo "âœ… Simulator is booted and ready"
        else
          echo "âŒ ERROR: Simulator is not booted. Install workflow should have prepared this."
          echo "Expected simulator to be ready from previous workflow step."
          exit 1
        fi
        
        # Verify app is installed (optional check - don't fail if we can't verify)
        if xcrun simctl listapps "${{ env.DEVICE_UDID }}" 2>/dev/null | grep -q "${{ env.APP_BUNDLE_ID }}"; then
          echo "âœ… App is installed and ready"
        else
          echo "âš ï¸ WARNING: Could not verify app installation, but proceeding with test"
          echo "Appium will provide better error messages if app is missing"
        fi
        
        echo "ðŸŽ¯ Ready to start Appium tests"
        
    - name: Start Appium Server
      shell: bash
      env:
        APPIUM_HOST: ${{ inputs.appium_host }}
        APPIUM_PORT: ${{ inputs.appium_port }}
      run: |
        echo "Starting Appium server..."
        appium --log-level info --log appium.log &
        APPIUM_PID=$!
        echo ${APPIUM_PID} > appium.pid
        echo "Appium PID: ${APPIUM_PID}"
        
        # Wait for Appium to start
        APPIUM_WAIT_SECONDS=65
        echo "Waiting for Appium server to start (timeout: ${APPIUM_WAIT_SECONDS}s)..."
        for i in $(seq 1 ${APPIUM_WAIT_SECONDS}); do
          if curl -s "http://${APPIUM_HOST}:${APPIUM_PORT}/status" > /dev/null; then
            echo "âœ“ Appium server is ready"
            break
          fi
          if [ $i -eq ${APPIUM_WAIT_SECONDS} ]; then
            echo "âœ— Appium server failed to start within ${APPIUM_WAIT_SECONDS} seconds"
            cat appium.log
            exit 1
          fi
          echo "Waiting... ($i/${APPIUM_WAIT_SECONDS})"
          sleep 1
        done
        
    - name: Verify Appium Server
      shell: bash
      env:
        APPIUM_HOST: ${{ inputs.appium_host }}
        APPIUM_PORT: ${{ inputs.appium_port }}
      run: |
        echo "Verifying Appium server status..."
        curl -f "http://${APPIUM_HOST}:${APPIUM_PORT}/status" | jq '.'

    - name: Pre-test Debug Information
      shell: bash
      env:
        DEVICE_UDID: ${{ inputs.device_uuid }}
        DEVICE_NAME: ${{ inputs.device_name }}
        PLATFORM_VERSION: ${{ inputs.ios_version }}
        APP_BUNDLE_ID: ${{ inputs.app_bundle_id }}
        APPIUM_HOST: ${{ inputs.appium_host }}
        APPIUM_PORT: ${{ inputs.appium_port }}
      run: |
        echo "=== Pre-test Debug Information ==="
        echo "Environment Variables:"
        echo "DEVICE_UDID: ${{ env.DEVICE_UDID }}"
        echo "DEVICE_NAME: ${{ env.DEVICE_NAME }}"
        echo "PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}"
        echo "APP_BUNDLE_ID: ${{ env.APP_BUNDLE_ID }}"
        echo "APPIUM_HOST: ${{ env.APPIUM_HOST }}"
        echo "APPIUM_PORT: ${{ env.APPIUM_PORT }}"
        
        echo "Current Simulator Status:"
        xcrun simctl list devices | grep "${{ env.DEVICE_UDID }}" || echo "Device not found"
        
        echo "App Installation Status:"
        if xcrun simctl list devices | grep "${{ env.DEVICE_UDID }}" | grep -q "(Booted)"; then
          xcrun simctl listapps ${{ env.DEVICE_UDID }} | grep -i "${{ env.APP_BUNDLE_ID }}" || echo "App not found"
        else
          echo "Cannot check app status - simulator not booted"
        fi
        
        echo "Appium Server Status:"
        curl -s "http://${{ env.APPIUM_HOST }}:${{ env.APPIUM_PORT }}/status" | jq '.' || echo "Appium server not reachable"
        
    - name: Run Appium Tests
      shell: bash
      working-directory: ./app
      continue-on-error: false
      run: npx wdio run wdio.conf.js --suite welcome
        
    - name: Upload Appium logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: appium-logs-${{ github.run_number }}
        path: appium.log
        retention-days: 7
        if-no-files-found: warn
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          app/test-results/
          app/screenshots/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Capture simulator logs
      if: always()
      shell: bash
      env:
        DEVICE_UDID: ${{ inputs.device_uuid }}
      run: |
        echo "Capturing simulator logs..."
        xcrun simctl spawn ${{ env.DEVICE_UDID }} log collect --output simulator.log || true
        
    - name: Upload simulator logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: simulator-logs-${{ github.run_number }}
        path: simulator.log
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Shutdown Simulator
      if: always()
      shell: bash
      env:
        DEVICE_UDID: ${{ inputs.device_uuid }}
      run: |
        echo "Shutting down simulator..."
        xcrun simctl shutdown ${{ env.DEVICE_UDID }} || true
        echo "âœ“ Simulator shutdown complete"
        
    - name: Stop Appium Server
      if: always()
      shell: bash
      run: |
        if [ -f appium.pid ]; then
          APPIUM_PID=$(cat appium.pid)
          echo "Stopping Appium server (PID: ${APPIUM_PID})..."
          kill ${APPIUM_PID} || true
          rm appium.pid
          echo "âœ“ Appium server stopped"
        fi
        
    - name: Cleanup
      if: always()
      shell: bash
      env:
        DEVICE_UDID: ${{ inputs.device_uuid }}
        APP_BUNDLE_ID: ${{ inputs.app_bundle_id }}
      run: |
        echo "Cleaning up test artifacts..."
        # Optional: Remove app from simulator
        # xcrun simctl uninstall ${{ env.DEVICE_UDID }} ${{ env.APP_BUNDLE_ID }} || true
        echo "âœ“ Cleanup complete"